package publish.subscribe.parser;

import java.net.Inet4Address;
import java.net.NetworkInterface;
import java.net.SocketException;
import java.util.Collections;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;

import json.messages.BaseMessage;
import json.messages.PossibleStatesMessage;
import json.messages.SelectedStateMessage;

public class Client implements ClientInterface {
	
	private SenderInterface sender;
	private double[] possibleStates;
	private double initState;
	private double selectedState;
	
	private String clientIP;
	private String clientID;
	
	private String serverIP;
	private String serverPort;
	
	public Client() {
		// TODO Auto-generated constructor stub
		
		try {
			clientIP = getMyIp();
		} catch (SocketException e) {
			e.printStackTrace();
		}
		clientID = "ExampleID";
		
		GetPropertyValues properties = new GetPropertyValues();
		serverIP = properties.serverIP;
		serverPort = properties.serverPort;
		
		sender = new Sender();
		possibleStates = new double[4];
		possibleStates[0] = 1;
		possibleStates[1] = 2;
		possibleStates[2] = 3;
		possibleStates[3] = 4;
		initState = 1;
		selectedState = 2;
	}
	
	@Override
	public void start() {
		this.sendPossibleStates();
		this.sendSelectedState();
	}

	@Override
	public void setPossibleStates(double[] possibleStates) {
		this.possibleStates = possibleStates;		
	}

	@Override
	public void setSelectedStates(double selectedState) {
		this.selectedState = selectedState;
	}

	@Override
	public void sendPossibleStates() {
		
		PossibleStatesMessage posStMsg = 
				new PossibleStatesMessage(
						"ExampleSourceIP",
						"ExampleDestIP",
						"ExampleSourceID",
						"ExampleDestID",
						this.possibleStates, 
						this.initState);
		
		String serverIP = TestConstants.serverIP;  	// TODO: Test
		String port = TestConstants.port;			// TODO: Test
		
		String stringMessage;
		try {
			stringMessage = objectToString(posStMsg);
		} catch (JsonProcessingException e1) {
			e1.printStackTrace();
			return;
		}
		
		// Send
		try {
			this.sender.send(stringMessage, serverIP, port);
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	@Override
	public void sendSelectedState() {
		
		SelectedStateMessage selStMsg = 
				new SelectedStateMessage(
						"ExampleSourceIP",
						"ExampleDestIP",
						"ExampleSourceID",
						"ExampleDestID"	);

		String serverIP = TestConstants.serverIP;  	// TODO: Test
		String port = TestConstants.port;			// TODO: Test
		
		String stringMessage;
		try {
			stringMessage = objectToString(selStMsg);
		} catch (JsonProcessingException e1) {
			e1.printStackTrace();
			return;
		}
		
		// Send
		try {
			this.sender.send(stringMessage, serverIP, port);
		} catch (Exception e) {
			e.printStackTrace();
		}
	}
	
	public static String objectToString(BaseMessage messageObj) throws JsonProcessingException{
		ObjectMapper om = new ObjectMapper();
		String stringMessage = om.writeValueAsString(messageObj);
		return stringMessage;
	}
	
	public static String getMyIp() throws SocketException {

	    return Collections.list(NetworkInterface.getNetworkInterfaces()).stream()
	            .flatMap(i -> Collections.list(i.getInetAddresses()).stream())
	            .filter(ip -> ip instanceof Inet4Address && ip.isSiteLocalAddress())
	            .findFirst().orElseThrow(RuntimeException::new)
	            .getHostAddress();
	}
	
	public static void main(String[] args){
		Client client = new Client();
		client.start();
	}
}
